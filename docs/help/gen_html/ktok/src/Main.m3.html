<HTML>
<HEAD>
<TITLE>Critical Mass Modula-3: ktok/src/Main.m3</TITLE>
</HEAD>
<BODY bgcolor="#ffffff">
<A NAME="0TOP0">
<H2>ktok/src/Main.m3</H2></A><HR>
<inModule>
<PRE></PRE> Copyright (c) 2000 California Institute of Technology 
 All rights reserved. See the file COPYRIGHT for a full description. 
 $Id: Main.m3.html,v 1.3 2010-04-29 17:18:50 wagner Exp $ 

<P><PRE>MODULE <module><implements><A HREF="../../m3core/src/main/Main.i3.html">Main</A></implements></module>;
IMPORT <A HREF="../derived/tokformBundle.i3.html">tokformBundle</A>, <A HREF="../../libm3/src/bundleintf/Bundle.i3.html">Bundle</A>;
IMPORT <A HREF="../../ktoklib/src/TokParams.i3.html">TokParams</A>;
IMPORT <A HREF="../../ktoklib/src/TokSpec.i3.html">TokSpec</A>;
IMPORT <A HREF="../../libm3/src/rw/FileWr.i3.html">FileWr</A>, <A HREF="../../libm3/src/rw/Wr.i3.html">Wr</A>, <A HREF="../../m3core/src/thread/Common/Thread.i3.html">Thread</A>, <A HREF="../../libm3/src/os/Common/OSError.i3.html">OSError</A>;
IMPORT <A HREF="../../libm3/src/rw/TextWr.i3.html">TextWr</A>;
IMPORT <A HREF="../../cit_util/src/TextSubs.i3.html">TextSubs</A>;
IMPORT <A HREF="../../libm3/derived/TextList.i3.html">TextList</A>;
IMPORT <A HREF="../../libm3/src/os/Common/Pathname.i3.html">Pathname</A>;
IMPORT <A HREF="../../libm3/src/fmtlex/Fmt.i3.html">Fmt</A>;
IMPORT <A HREF="../../ktoklib/src/FmtTable.i3.html">FmtTable</A>;
</PRE><BLOCKQUOTE><EM> IMPORT Term; </EM></BLOCKQUOTE><PRE>
&lt;* FATAL Thread.Alerted, Wr.Failure, OSError.E *&gt;

VAR
  Form := tokformBundle.Get();

PROCEDURE <A NAME="FormatTypes"><procedure>FormatTypes</procedure></A>(t: TextList.T; tokName, kind: TEXT): TEXT =
  VAR
    wr := TextWr.New();
    cur := t;
    subs: TextSubs.T;
  BEGIN
    WHILE cur # NIL DO
      subs := NEW(TextSubs.T).init();
      subs.add(&quot;%type&quot;, cur.head);
      subs.add(&quot;%tok&quot;, tokName);
      Wr.PutText(wr, subs.apply(Bundle.Get(Form, kind)));
      cur := cur.tail;
    END;
    RETURN TextWr.ToText(wr);
  END FormatTypes;

PROCEDURE <A NAME="FormatLegalConst"><procedure>FormatLegalConst</procedure></A>(tok: TokSpec.T): TEXT =
  VAR
    dummy: TEXT;
    fmt := NEW(FmtTable.T).init();
  BEGIN
    FOR i := 1 TO tok.lastConstCode DO
      IF tok.constTokensR.get(i, dummy) THEN
        fmt.putInt(i);
      END;
    END;
    RETURN fmt.toText();
  END FormatLegalConst;

PROCEDURE <A NAME="FormatNamedConst"><procedure>FormatNamedConst</procedure></A>(tok: TokSpec.T): TEXT =
  VAR
    cur := tok.tokens;
    name: TEXT;
    code: INTEGER;
    wr := TextWr.New();
  BEGIN
    WHILE cur # NIL DO
      name := cur.head;
      IF tok.constTokens.get(name, code) THEN
        Wr.PutText(wr, &quot;    &quot; &amp; name &amp; &quot; = &quot; &amp; Fmt.Int(code) &amp; &quot;;\n&quot;);
      END;
      cur := cur.tail;
    END;
    RETURN TextWr.ToText(wr);
  END FormatNamedConst;

PROCEDURE <A NAME="Subs"><procedure>Subs</procedure></A>(tok: TokSpec.T; name: TEXT): TextSubs.T =
  VAR
    subs := NEW(TextSubs.T).init();
  BEGIN
    subs.add(&quot;\\\n&quot;, &quot;&quot;);
    subs.add(&quot;%tok&quot;, name);
    subs.add(&quot;%type&quot;, FormatTypes(tok.varTokens, name, &quot;tokform.type&quot;));
    subs.add(&quot;%case&quot;, FormatTypes(tok.varTokens, name, &quot;tokform.case&quot;));
    subs.add(&quot;%constSet&quot;, FormatLegalConst(tok));
    subs.add(&quot;%constName&quot;, FormatNamedConst(tok));
    subs.add(&quot;%lastConst&quot;, Fmt.Int(tok.lastConstCode));
    subs.add(&quot;%gen&quot;, &quot;(* Generated by ktok *)&quot;);
    RETURN subs;
  END Subs;

VAR
  tp := TokParams.Get(&quot;tok&quot;, &quot;.t&quot;, &quot;Tok.i3&quot;, FALSE);
  tok := TokParams.ReadTokens(tp);
  subs := Subs(tok, tp.outBase);
  wr: Wr.T;
BEGIN
  wr := FileWr.Open(tp.out);
  Wr.PutText(wr, subs.apply(Bundle.Get(Form, &quot;tokform.i3&quot;)));
  Wr.Close(wr);

  wr := FileWr.Open(Pathname.ReplaceExt(tp.out, &quot;m3&quot;));
  Wr.PutText(wr, subs.apply(Bundle.Get(Form, &quot;tokform.m3&quot;)));
  Wr.Close(wr);
END Main.
</PRE>
</inModule>
<PRE>























</PRE>
</BODY>
</HTML>
