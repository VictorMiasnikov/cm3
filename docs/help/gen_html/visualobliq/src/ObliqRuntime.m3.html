<HTML>
<HEAD>
<TITLE>Critical Mass Modula-3: visualobliq/src/ObliqRuntime.m3</TITLE>
</HEAD>
<BODY bgcolor="#ffffff">
<A NAME="0TOP0">
<H2>visualobliq/src/ObliqRuntime.m3</H2></A><HR>
<inModule>
<PRE></PRE> Copyright (C) 1993 Digital Equipment Corporation.                   
 All rights reserved. See the file COPYRIGHT for a full description. 

<P> Last modified on Tue Sep  6 16:25:43 PDT 1994 by bharat 
      modified on Thu Mar 10 10:01:04 PST 1994 by mhb  
      modified on Fri Sep 10 15:01:41 1993 by luca 

<P><PRE>MODULE <module><implements><A HREF="ObliqRuntime.i3.html">ObliqRuntime</A></implements></module>;

IMPORT <A HREF="../../obliq/src/ObliqOnline.i3.html">ObliqOnline</A>;
IMPORT <A HREF="../../obliqlibm3/src/ObLibM3.i3.html">ObLibM3</A>; (* rd,wr,lex,fmt,pickle,process,thread *)
IMPORT <A HREF="../../obliqlibui/src/ObLibUI.i3.html">ObLibUI</A>; (* color,form *)
IMPORT <A HREF="Dialog.i3.html">Dialog</A>, <A HREF="../../vbtkit/src/vbtkitutils/Rsrc.i3.html">Rsrc</A>, <A HREF="NodeVBT.i3.html">NodeVBT</A>, <A HREF="../../libm3/src/rw/TextRd.i3.html">TextRd</A>, <A HREF="../../m3core/src/thread/Common/Thread.i3.html">Thread</A>;

CONST Greetings = &quot;Internal Obliq interpreter installed...&quot;;

TYPE
  Closure = Thread.SizedClosure OBJECT
              t: TEXT;
            OVERRIDES
              apply := ForkedDo;
            END;

VAR (* probably should not be global *)
  interp: ObliqOnline.T;

PROCEDURE <A NAME="Do"><procedure>Do</procedure></A> (t: TEXT) =
  BEGIN
    EVAL
      Thread.Join(
        Thread.Fork(
          NEW(Closure, t := t,
              stackSize := 2 * Thread.GetDefaultStackSize())));
  END Do;

PROCEDURE <A NAME="ForkedDo"><procedure>ForkedDo</procedure></A> (cl: Closure): REFANY =
  BEGIN
    ObliqOnline.Interact(interp,
      rd := TextRd.New(cl.t),
      rdName := &quot;file generated by Visual Obliq&quot;,
      closeRd := TRUE,
      generateEOF := TRUE);
    RETURN NIL
  END ForkedDo;

PROCEDURE <A NAME="loadObliqRsrc"><procedure>loadObliqRsrc</procedure></A>(name: TEXT) =
  BEGIN
     TRY
      WITH  loadedFile = Rsrc.Get(name, Dialog.rsrcPath) DO
        Do(loadedFile);
      END;
    EXCEPT
      Rsrc.NotFound =&gt;NodeVBT.print(&quot;Error: Cannot find '&quot; &amp; name &amp; &quot;' in resource bundle\n&quot;);
    ELSE
     NodeVBT.print(&quot;Error: while executing '&quot; &amp; name &amp; &quot;'\n&quot;);
    END (* TRY *);
  END loadObliqRsrc;

PROCEDURE <A NAME="Setup"><procedure>Setup</procedure></A>() =
 BEGIN
  ObliqOnline.Setup();
  ObLibM3.PackageSetup();
  ObLibUI.PackageSetup();

  (* Don't load default .obliq - who knows what it contains *)
  interp := ObliqOnline.New(Greetings, NIL,  FALSE);

  (* Feed it the bundled obliq start-up files *)

  (* temporarily mask this:-
     loadObliqRsrc(&quot;netobjexec.obl&quot;);
  *)
  loadObliqRsrc(&quot;templates.obl&quot;);
  loadObliqRsrc(&quot;vowidgets.obl&quot;);
  loadObliqRsrc(&quot;vocheckpt.obl&quot;);
  loadObliqRsrc(&quot;volib.obl&quot;);
  loadObliqRsrc(&quot;vos-internal.obl&quot;);

  Do(&quot;;&quot;);

END Setup;

BEGIN
END ObliqRuntime.
</PRE>
</inModule>
<PRE>























</PRE>
</BODY>
</HTML>
